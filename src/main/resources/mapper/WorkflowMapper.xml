<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.quickform.api.mapper.WorkflowMapper">

  <insert id="insertTask">
    INSERT INTO workflow_task (record_id, page_code, node_code, assignee, status, action, comment)
    VALUES (#{recordId}, #{pageCode}, #{nodeCode}, #{assignee}, #{status}, #{action}, #{comment})
  </insert>

  <select id="listTasks" resultType="map">
    SELECT * FROM workflow_task
    <where>
      <if test="assignee != null and assignee != ''">assignee = #{assignee}</if>
      <if test="pageCode != null and pageCode != ''">AND page_code = #{pageCode}</if>
    </where>
    ORDER BY created_at DESC
  </select>

  <select id="getWorkflow" resultType="map">
    SELECT * FROM workflow WHERE page_code = #{pageCode} ORDER BY id DESC LIMIT 1
  </select>

  <select id="findWorkflowIdByPageCode" resultType="long">
    SELECT id FROM workflow WHERE page_code = #{pageCode} ORDER BY id DESC LIMIT 1
  </select>

  <select id="insertWorkflow" resultType="long">
    INSERT INTO workflow (page_code, name, config_json)
    VALUES (#{pageCode}, #{name}, #{configJson}::jsonb)
    RETURNING id
  </select>

  <update id="updateWorkflow">
    UPDATE workflow SET name = COALESCE(#{name}, name), config_json = #{configJson}::jsonb, updated_at = NOW() WHERE id = #{id}
  </update>

  <select id="findPendingTaskIds" resultType="long">
    SELECT id FROM workflow_task WHERE record_id = #{recordId} AND node_code = #{nodeCode} AND status = 'pending' ORDER BY id
  </select>

  <select id="findPendingTaskIdByAssignee" resultType="long">
    SELECT id FROM workflow_task WHERE record_id = #{recordId} AND node_code = #{nodeCode} AND status = 'pending' AND assignee = #{assignee} ORDER BY id LIMIT 1
  </select>

  <select id="findPendingTaskIdByRecordAndAssignee" resultType="long">
    SELECT id FROM workflow_task WHERE record_id = #{recordId} AND status = 'pending' AND assignee = #{assignee} ORDER BY id LIMIT 1
  </select>

  <select id="getTaskNodeCode" resultType="string">
    SELECT node_code FROM workflow_task WHERE id = #{id}
  </select>

  <update id="updateTask">
    UPDATE workflow_task SET status = #{status}, action = #{action}, comment = #{comment} WHERE id = #{id}
  </update>

  <update id="cancelPendingTasks">
    UPDATE workflow_task SET status = 'cancelled', action = 'skip'
    WHERE record_id = #{recordId} AND node_code = #{nodeCode} AND status = 'pending'
  </update>

  <update id="cancelAllPendingTasks">
    UPDATE workflow_task SET status = 'cancelled', action = 'skip'
    WHERE record_id = #{recordId} AND status = 'pending'
  </update>

  <select id="countPendingTasks" resultType="long">
    SELECT COUNT(1) FROM workflow_task WHERE record_id = #{recordId} AND node_code = #{nodeCode} AND status = 'pending'
  </select>

  <update id="updateRecordStatus">
    UPDATE data_record SET status = #{status}, updated_at = NOW(), updated_by = #{operator}
    WHERE id = #{recordId} AND page_code = #{pageCode}
  </update>

  <update id="touchRecord">
    UPDATE data_record SET updated_at = NOW(), updated_by = #{operator}
    WHERE id = #{recordId} AND page_code = #{pageCode}
  </update>

</mapper>
