<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.quickform.api.mapper.MetaMapper">

  <select id="listDatasets" resultType="map">
    SELECT * FROM dataset ORDER BY id
  </select>

  <select id="listDatasetsByAppId" resultType="map">
    SELECT * FROM dataset WHERE app_id = #{appId} ORDER BY id
  </select>

  <select id="listDatasetsByAppCode" resultType="map">
    SELECT d.* FROM dataset d JOIN app a ON d.app_id = a.id WHERE a.code = #{appCode} ORDER BY d.id
  </select>

  <select id="getDatasetById" resultType="map">
    SELECT * FROM dataset WHERE id = #{id}
  </select>

  <select id="getDatasetByCode" resultType="map">
    SELECT * FROM dataset WHERE code = #{code}
  </select>

  <select id="getAppIdByCode" resultType="long">
    SELECT id FROM app WHERE code = #{code}
  </select>

  <select id="createDataset" resultType="long">
    INSERT INTO dataset (app_id, name, code, primary_key, options)
    VALUES (#{appId}, #{name}, #{code}, #{primaryKey}, #{optionsJson}::jsonb)
    RETURNING id
  </select>

  <select id="listFields" resultType="map">
    SELECT * FROM field WHERE dataset_id = #{datasetId} AND is_deleted = FALSE ORDER BY order_no, id
  </select>

  <select id="listFieldInfos" resultType="com.quickform.api.model.FieldInfo">
    SELECT code, type FROM field WHERE dataset_id = #{datasetId} AND is_deleted = FALSE
  </select>

  <select id="createField" resultType="long">
    INSERT INTO field (dataset_id, name, code, type, required, default_value, options, order_no)
    VALUES (#{datasetId}, #{name}, #{code}, #{type}, #{required}, #{defaultValue}, #{optionsJson}::jsonb, #{orderNo})
    RETURNING id
  </select>

  <update id="updateField" parameterType="com.quickform.api.model.FieldUpdateParam">
    UPDATE field
    <set>
      <if test="name != null">name = #{name},</if>
      <if test="type != null">type = #{type},</if>
      <if test="required != null">required = #{required},</if>
      <if test="defaultValue != null">default_value = #{defaultValue},</if>
      <if test="optionsJson != null">options = #{optionsJson}::jsonb,</if>
      <if test="orderNo != null">order_no = #{orderNo},</if>
      <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
    </set>
    WHERE id = #{id}
  </update>

  <update id="softDeleteField">
    UPDATE field SET is_deleted = TRUE WHERE id = #{id}
  </update>

</mapper>
